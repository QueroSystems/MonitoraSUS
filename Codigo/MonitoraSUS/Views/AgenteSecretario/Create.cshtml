@model Model.PessoaModel
@using System.Collections.Generic

@{
	ViewData["Title"] = "Create";

	var typeCad = ViewBag.userType == 1 ? "Gestor de Saúde" : "Responsável pela realização de Exames";
	var perguntaVinculo = ViewBag.userType == 1 ? "Qual estado/município você é gestor de saúde?" : "Em qual estado/município irá notificar resultados de exames?";

	var caseController = typeCad == "Agente" ? "CreateAgent" : "CreateSec";
	var listaDeEstados = ViewBag.estados as List<Model.PessoaModel>;
	var googleKey = ViewBag.googleKey;
}



<div class="container-fluid mt--6">
    <div class="row">
        <div class="col-md-12">
            <div class="card card-content">
                <div class="card-header bg-transparent">
                    <div class="row align-items-center">
                        <div class="col">
                            <h6 class="text-uppercase text-muted ls-1 mb-1">MonitoraSUS</h6>
                            <h5 class="h3 mb-0">Cadastro de @typeCad</h5>
                        </div>
                        <a asp-controller="AgenteSecretario" asp-action="Index" class="btn btn-sm btn-default">
                            <i class="fas fa-arrow-left"></i> Voltar
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <form asp-controller="AgenteSecretario" asp-action="@caseController" autocomplete="off">
                        <h6 class="heading-small text-muted mb-4">Dados Pessoais</h6>
                        <div class="pl-lg-4">
                            <div class="row">
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label class="form-control-label" for="input-cpf">CPF</label>
                                        <input type="text" id="input-cpf" asp-for="Cpf" onfocus="loadEstados()" oninput="validaCpf()" required class="form-control" placeholder="000.000.000-00">
                                        <span id="spanInvalidCpf" hidden class="text-danger text-center" style="padding: 10px">CPF Invalido!!</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-control-label" for="input-nome">Nome</label>
                                        <input type="search" id="input-nome" asp-for="Nome" required class="form-control" placeholder="Nome Completo">
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label for="input-data-nascimento" class="form-control-label">Data de Nascimento</label>
                                        <input class="form-control" type="date" asp-for="DataNascimento" required id="input-data-nascimento">
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label class="form-control-label" for="sexo">Sexo</label><br>
                                        <div class="custom-control custom-radio custom-control-inline">
                                            <input type="radio" id="input-sexo-masc" required name="sexo" value="Masculino" class="custom-control-input">
                                            <label class="custom-control-label" for="input-sexo-masc">Masculino</label>
                                        </div>
                                        <div class="custom-control custom-radio custom-control-inline">
                                            <input type="radio" id="input-sexo-fem" required name="sexo" value="Feminino" class="custom-control-input">
                                            <label class="custom-control-label" for="input-sexo-fem">Feminino</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <hr class="my-4" />
                        <h6 class="heading-small text-muted mb-4">Informações de Contato</h6>
                        <div class="pl-lg-4">
                            <div class="row">
                                <div class="col-lg-12">
                                    <div class="form-group">
                                        <label class="form-control-label" for="input-pesquisa">Pesquisa Endereço</label>
                                        <input type="search" id="input-pesquisa" required class="form-control" oninput="PreencheForm()" placeholder="Pesquise pelo CEP, Rua, Bairro, Número" autocomplete="off">
                                        <span id="spanInvalidCep" hidden class="text-danger text-center" style="padding: 10px">Cep Invalido!!</span>
                                        <input type="hidden" id="longitude" asp-for="Longitude" />
                                        <input type="hidden" id="latitude" asp-for="Latitude" />
                                    </div>
                                </div>
                                <div class="col-lg-2">
                                    <div class="form-group">
                                        <label class="form-control-label" for="input-cep">CEP</label>
                                        <input id="postal_code" class="form-control" asp-for="Cep" name="Cep" required placeholder="CEP" type="text">
                                    </div>
                                </div>
                                <div class="col-lg-5">
                                    <div class="form-group">
                                        <label class="form-control-label" for="input-logradouro">Logradouro</label>
                                        <input type="text" id="route" required class="form-control" asp-for="Rua" name="Logradouro" placeholder="Rua, Av, Travessa">
                                    </div>
                                </div>
                                <div class="col-lg-1">
                                    <div class="form-group">
                                        <label class="form-control-label" for="input-numero">Número</label>
                                        <input type="text" id="street_number" class="form-control" asp-for="Numero" name="Numero" placeholder="">
                                    </div>
                                </div>
                                <div class="col-lg-4">
                                    <div class="form-group">
                                        <label class="form-control-label" for="input-bairro">Bairro</label>
                                        <input type="text" id="input-bairro" required class="form-control" asp-for="Bairro" name="Bairro" placeholder="Bairro">
                                    </div>
                                </div>
                                <div class="col-lg-4">
                                    <div class="form-group">
                                        <label class="form-control-label" for="input-cidade">Cidade</label>
                                        <input type="text" id="administrative_area_level_2" required class="form-control" asp-for="Cidade" name="Localidade" placeholder="Cidade">
                                    </div>
                                </div>
                                <div class="col-lg-4">
                                    <div class="form-group">
                                        <label class="form-control-label" for="input-estado">Estado</label>
                                        <input type="text" id="administrative_area_level_1" class="form-control" asp-for="Estado" name="UF" placeholder="Estado">
                                    </div>
                                </div>
                                <div class="col-lg-4">
                                    <div class="form-group">
                                        <label class="form-control-label" for="input-complemento">Complemento</label>
                                        <input type="text" id="input-complemento" class="form-control" asp-for="Complemento" placeholder="Complemento">
                                    </div>
                                </div>
                                <div class="col-lg-4">
                                    <div class="form-group">
                                        <label class="form-control-label" for="input-celular">Celular</label>
                                        <input type="text" id="input-celular" required class="form-control" asp-for="FoneCelular" placeholder=" (99) 99999 9999">
                                    </div>
                                </div>
                                <div class="col-lg-4">
                                    <div class="form-group">
                                        <label class="form-control-label" for="input-telefone">Telefone</label>
                                        <input type="text" id="input-telefone" class="form-control" asp-for="FoneFixo" placeholder=" (99) 9999 9999">
                                    </div>
                                </div>
                                <div class="col-lg-4">
                                    <div class="form-group">
                                        <label class="form-control-label" for="input-email">E-mail</label>
                                        <input type="email" id="input-email" class="form-control" required asp-for="Email" placeholder="email@example.com">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <hr class="my-4" />
                        <h6 class="heading-small text-muted mb-4">Comorbidades</h6>
                        <div class="pl-lg-4">
                            <div class="row">
                                <div class="col-lg-3">
                                    <div class="custom-control custom-checkbox">
                                        <input type="checkbox" class="custom-control-input" id="Hipertenso" asp-for="Hipertenso">
                                        <label class="custom-control-label" for="Hipertenso">Hipertensão</label>
                                    </div>
                                </div>
                                <div class="col-lg-3">
                                    <div class="custom-control custom-checkbox">
                                        <input type="checkbox" class="custom-control-input" id="Diabetes" asp-for="Diabetes">
                                        <label class="custom-control-label" for="Diabetes">Diabetes</label>
                                    </div>
                                </div>
                                <div class="col-lg-3">
                                    <div class="custom-control custom-checkbox">
                                        <input type="checkbox" class="custom-control-input" id="Obeso" asp-for="Obeso">
                                        <label class="custom-control-label" for="Obeso">Obeso</label>
                                    </div>
                                </div>
                                <div class="col-lg-3">
                                    <div class="custom-control custom-checkbox">
                                        <input type="checkbox" class="custom-control-input" id="Cardiopatia" asp-for="Cardiopatia">
                                        <label class="custom-control-label" for="Cardiopatia">Cardiopatia</label>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-lg-3">
                                    <div class="custom-control custom-checkbox">
                                        <input type="checkbox" class="custom-control-input" id="Imunodeprimido" asp-for="Imunodeprimido">
                                        <label class="custom-control-label" for="Imunodeprimido">Imunodeprimido</label>
                                    </div>
                                </div>
                                <div class="col-lg-3">
                                    <div class="custom-control custom-checkbox">
                                        <input type="checkbox" class="custom-control-input" id="Cancer" asp-for="Cancer">
                                        <label class="custom-control-label" for="Cancer">Câncer</label>
                                    </div>
                                </div>
                                <div class="col-lg-3">
                                    <div class="custom-control custom-checkbox">
                                        <input type="checkbox" class="custom-control-input" id="DoencaRespiratoria" asp-for="DoencaRespiratoria">
                                        <label class="custom-control-label" for="DoencaRespiratoria">Doença Respiratória</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <hr class="my-4" />
                        <h6 class="heading-small text-muted mb-4">@perguntaVinculo</h6>
                        <div class="pl-lg-4">
                            <div class="row">
                                <div class="col-lg-6">
                                    <div class="form-group">
                                        <label class="form-control-label" for="select-atuacao-estado">Estado</label>
                                        <select class="form-control" id="select-atuacao-estado" name="select-Estado" required onchange="cidadeSelect()">
                                            <option selected>Selecione o estado</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="form-group">
                                        <label class="form-control-label" for="select-atuacao-cidade">Município</label>
                                        <select class="form-control" id="select-atuacao-cidade" required name="select-Cidade" disabled>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label class="form-control-label" for="nivel-atuacao">Nível de Atuação:</label><br>
                                        <div class="custom-control custom-radio custom-control-inline">
                                            <input type="radio" id="input-atuacao-estadual" name="areaAtuacao" checked value="Estadual" required class="custom-control-input">
                                            <label class="custom-control-label" for="input-atuacao-estadual">Estadual</label>
                                        </div>
                                        <div class="custom-control custom-radio custom-control-inline">
                                            <input type="radio" id="input-atuacao-municipal" name="areaAtuacao" value="Municipal" required class="custom-control-input">
                                            <label class="custom-control-label" for="input-atuacao-municipal">Municipal</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <hr class="my-4" />
                        <div class="row align-items-center">
                            <div class="col text-right">
                                <button class="btn btn-success">Solicitar</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Scripts -->

@section Scripts {

    <!-- GOOGLE SETING SCRIPTS -->
    <script>
        var placeSearch, autocomplete, inputHtml, geocoder;
        inputHtml = document.getElementById('input-pesquisa')

        var componentForm = {
            route: 'long_name',
            street_number: 'short_name',
            administrative_area_level_1: 'short_name',
            administrative_area_level_2: 'long_name',
            postal_code: 'short_name'
        };

        function initAutocomplete() {
            autocomplete = new google.maps.places.Autocomplete(inputHtml, { types: ['geocode'] });
            geocoder = new google.maps.Geocoder();

            autocomplete.setFields(['address_component']);
            autocomplete.addListener('place_changed', fillInAddress);
        }

        function fillInAddress() {
            var place = autocomplete.getPlace();

            ProcuraEndereco(inputHtml.value);

            for (var component in componentForm) {
                document.getElementById(component).value = '';
            }

            for (var i = 0; i < place.address_components.length; i++) {
                var addressType = place.address_components[i].types[0];
                if (componentForm[addressType]) {
                    var val = place.address_components[i][componentForm[addressType]];
                    document.getElementById(addressType).value = val;

                    // DISABLE ONLY INPUTS THAT RECEIVED A VALID VALUE
                    if (val != '')
                        document.getElementById(addressType).setAttribute('readonly', 'true');
                }
            }
        }

        // Bias the autocomplete object to the user's geographical location,
        // as supplied by the browser's 'navigator.geolocation' object.
        function geolocate() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    var geolocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    var circle = new google.maps.Circle(
                        { center: geolocation, radius: position.coords.accuracy });
                    autocomplete.setBounds(circle.getBounds());
                });
            }
        }

        function ProcuraEndereco(endereco) {
            geocoder.geocode({ 'address': endereco }, function (results, status) {
                if (status === 'OK') {
                    let latitude = document.getElementById('latitude');
                    let longitude = document.getElementById('longitude');

                    // SETTING VALUES
                    latitude.value = results[0].geometry.location.lat();
                    longitude.value = results[0].geometry.location.lng();
                } else {
                    alert('ERRO AO INICIALIZAR O GEOCODE: ' + status);
                }
            });
        }
    </script>

    <!-- PERSONAL SCRIPTS -->
    <script>
        function clearSelect() {
            let selectCities = document.getElementById('select-atuacao-cidade');

            for (let i = 0; i < selectCities.length; i++) {
                selectCities.options.remove(i);
                clearSelect();
            }
        }

        function cidadeSelect() {
            let estado = document.getElementById('select-atuacao-estado').value

            let url = "/AgenteSecretario/ReturnCities";

            $.post(url, { UF: estado }, function (data) {
                let selectCities = document.getElementById('select-atuacao-cidade');
                selectCities.disabled = true;
                clearSelect();

                for (let i = 0; i < data.length; i++) {
                    let option = document.createElement("option");
                    option.text = data[i].nome;
                    option.value = data[i].id;

                    selectCities.add(option);
                }

                selectCities.disabled = false;
            })
        }

        function loadEstados() {
            let selectEstados = document.getElementById('select-atuacao-estado');
            let url = "/AgenteSecretario/ReturnStates";

            $.get(url, null, function (data) {
                for (let i = 0; i < data.length; i++) {
                    let option = document.createElement("option");
                    option.text = data[i].nome;
                    option.value = data[i].codigoUf;

                    selectEstados.add(option);
                }
            })
        }

        function validaCpf() {
            let cpf = document.getElementById('input-cpf')
            let span = document.getElementById('spanInvalidCpf')

            let url = "/Login/ValidaCpf";

            $.post(url, { cpf: cpf.value }, function (data) {
                if (!data) {
                    cpf.className = "form-control form-control-user border-danger cpf";
                    cpf.style = "border-width: 2px;";
                    span.hidden = false;
                } else {
                    cpf.className = "form-control form-control-user cpf";
                    cpf.style = "";
                    span.hidden = true;
                }
            })
        }
    </script>
    <script>
        function PreencheForm() {
            let input = document.getElementById('input-pesquisa');
            let span = document.getElementById('spanInvalidCep');

            if (!isNaN(input.value) && input.value !== '' && input.value.length == 8) {
                let url = `https://viacep.com.br/ws/${input.value}/json/`;

                $.get(url, null, function (data) {
                    let formCep = {
                        cep: document.getElementById('postal_code'),
                        complemento: document.getElementById('input-complemento'),
                        bairro: document.getElementById('input-bairro'),
                        localidade: document.getElementById('administrative_area_level_2'),
                        uf: document.getElementById('administrative_area_level_1'),
                        logradouro: document.getElementById('route')
                    };

                    if (!data.erro) {
                        for (let input in formCep) {
                            span.hidden = true;
                            formCep[input].value = '';
                            for (let value in data) {
                                if (formCep[input].name.toLowerCase() == value) {
                                    formCep[input].value = data[value];
                                    formCep[input].setAttribute('readonly', 'true');
                                }
                            }
                        }

                        ProcuraEndereco(formCep.logradouro.value);
                    } else
                        span.hidden = false;
                })
            }
        }
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=@googleKey&libraries=places&callback=initAutocomplete&language=pt-BR"
            async defer></script>
}
